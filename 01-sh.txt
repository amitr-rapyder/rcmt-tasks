#!/bin/bash

set -e

echo "Creating output file..."
{
    echo "Date and Time:"
    date
} > /home/amitdemo/output.txt


pwsh << 'EOF'
# Connect using managed identity
Connect-AzAccount -Identity

# Get the storage account
$storageAccount = Get-AzStorageAccount -ResourceGroupName "CoE" -Name "amitdemovm"
$context = $storageAccount.Context

$year = (Get-Date).Year
$month = (Get-Date).Month.ToString("00")
$day = (Get-Date).Day.ToString("00")

$blobPath = "$year/$month/$day/output.txt"
$fullBlobPath = "folder01/$blobPath"

# Check if blob exists
$blobExists = Get-AzStorageBlob -Container "amitdemovm" -Blob $fullBlobPath -Context $context -ErrorAction SilentlyContinue

if ($blobExists) {
    Write-Output "File already present in the container at path: $fullBlobPath"
} else {
    Set-AzStorageBlobContent -File "/home/amitdemo/output.txt" -Container "amitdemovm" -Blob $fullBlobPath -Context $context
    Write-Output "File uploaded successfully to: $fullBlobPath"

    # Create an empty blob for the second folder
    # Creating a temporary empty file and uploading it
    $tempFile = New-TemporaryFile
    Set-AzStorageBlobContent -File $tempFile.FullName -Container "amitdemovm" -Blob "folder02/.folder" -Context $context
    Remove-Item $tempFile
}
EOF