#!/bin/bash

# Error handling
set -e

# Create output file
echo "Creating output file..."
{
    echo "Date and Time:"
    date
} > /home/amitdemo/output.txt

# Upload to blob and create folders using PowerShell
pwsh << 'EOF'
# Connect using managed identity
Connect-AzAccount -Identity

# Get the storage account
$storageAccount = Get-AzStorageAccount -ResourceGroupName "CoE" -Name "amitdemovm"
$context = $storageAccount.Context

# Get current date components
$year = (Get-Date).Year
$month = (Get-Date).Month.ToString("00")
$day = (Get-Date).Day.ToString("00")

# Create the dynamic path
$blobPath = "$year/$month/$day/output.txt"

# Upload the file to the first folder with dynamic date-based path
Set-AzStorageBlobContent -File "/home/amitdemo/output.txt" -Container "amitdemovm" -Blob "folder01/$blobPath" -Context $context

# Create an empty blob for the second folder
# Creating a temporary empty file and uploading it
$tempFile = New-TemporaryFile
Set-AzStorageBlobContent -File $tempFile.FullName -Container "amitdemovm" -Blob "folder02/.folder" -Context $context
Remove-Item $tempFile

Write-Output "Script executed successfully. The files have been uploaded to the container."
EOF